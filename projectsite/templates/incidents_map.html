{% extends 'base.html' %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

<div class="page-inner">
  <div class="page-header">
    <h4 class="page-title">Fire Incidents</h4>
    <ul class="breadcrumbs">
      <li class="nav-home">
        <a href="{% url 'home' %}">
          <i class="flaticon-home"></i>
        </a>
      </li>
      <li class="separator">
        <i class="flaticon-right-arrow"></i>
      </li>
      <li class="nav-item">
        <a href="#">Maps</a>
      </li>
      <li class="separator">
        <i class="flaticon-right-arrow"></i>
      </li>
      <li class="nav-item">
        <a href="">Incidents</a>
      </li>
    </ul>
  </div>

  <!-- Filter Dropdown -->
  <div class="col-md-12">
    <div class="card card-transparent">
      <div class="card-body">
        <div class="col-md-4 ml-auto mr-auto">
          <label for="cityFilter">Filter by City:</label>
          <select id="cityFilter" class="form-control">
            <option value="all">All Cities</option>
            <option value="PPCA">PPC A</option>
            <option value="PPCB">PPC B</option>
            <option value="PPCC">PPC C</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Incident Controls -->
  <div class="incident-controls text-center my-3">
    <button type="button" class="btn btn-success" data-toggle="modal" data-target="#addIncidentModal">Add Incident</button>
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#editIncidentModal">Edit Incident</button>
    <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#deleteIncidentModal">Delete Incident</button>
  </div>

  <!-- Map Container -->
  <div class="col-md-12">
    <div class="card card-transparent">
      <div class="card-header">
        <h4 class="card-title text-center">Fire Incidents Map</h4>
      </div>
      <div class="card-body">
        <div class="col-md-10 ml-auto mr-auto">
          <div id="map" style="width: 100%; height: 400px;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Incident Modal -->
<div class="modal fade" id="addIncidentModal" tabindex="-1" role="dialog" aria-labelledby="addIncidentModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form method="post" action="{% url 'add_incident' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addIncidentModalLabel">Add Incident</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
             <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- Location Fields -->
          <h6>Location Details</h6>
          <div class="form-group">
            <label for="locationName">Location Name</label>
            <input type="text" class="form-control" id="locationName" name="location_name" required>
          </div>
          <div class="form-group">
            <label for="incidentLatitude">Latitude</label>
            <input type="number" step="any" class="form-control" id="incidentLatitude" name="latitude" required>
          </div>
          <div class="form-group">
            <label for="incidentLongitude">Longitude</label>
            <input type="number" step="any" class="form-control" id="incidentLongitude" name="longitude" required>
          </div>
          <div class="form-group">
            <label for="locationAddress">Address</label>
            <input type="text" class="form-control" id="locationAddress" name="address" required>
          </div>
          <div class="form-group">
            <label for="locationCity">City</label>
            <input type="text" class="form-control" id="locationCity" name="city" required>
          </div>
          <div class="form-group">
            <label for="locationCountry">Country</label>
            <input type="text" class="form-control" id="locationCountry" name="country" required>
          </div>
          <!-- Incident Fields -->
          <h6>Incident Details</h6>
          <div class="form-group">
            <label for="incidentDateTime">Date & Time</label>
            <input type="text" class="form-control" id="incidentDateTime" name="date_time" placeholder="YYYY-MM-DD HH:MM" required>
          </div>
          <div class="form-group">
            <label for="severityLevel">Severity Level</label>
            <select class="form-control" id="severityLevel" name="severity_level" required>
              {% for level in severity_levels %}
                <option value="{{ level }}">{{ level }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="incidentDescription">Description</label>
            <input type="text" class="form-control" id="incidentDescription" name="description" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Add Incident</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Incident Modal -->
<div class="modal fade" id="editIncidentModal" tabindex="-1" role="dialog" aria-labelledby="editIncidentModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form method="post" action="{% url 'edit_incident' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="editIncidentModalLabel">Edit Incident</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
             <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- Select Incident to Edit -->
          <div class="form-group">
            <label for="editIncidentSelect">Select Incident</label>
            <select class="form-control" id="editIncidentSelect" name="incident_id" required>
              <option value="">-- Select Incident --</option>
              {% for incident in fireIncidents %}
                <option value="{{ incident.id }}">{{ incident.description }}</option>
              {% endfor %}
            </select>
          </div>
          <!-- New Location Fields -->
          <h6>Update Location Details (Optional)</h6>
          <div class="form-group">
            <label for="editLocationName">Location Name</label>
            <input type="text" class="form-control" id="editLocationName" name="new_location_name">
          </div>
          <div class="form-group">
            <label for="editIncidentLatitude">Latitude</label>
            <input type="number" step="any" class="form-control" id="editIncidentLatitude" name="new_latitude">
          </div>
          <div class="form-group">
            <label for="editIncidentLongitude">Longitude</label>
            <input type="number" step="any" class="form-control" id="editIncidentLongitude" name="new_longitude">
          </div>
          <div class="form-group">
            <label for="editLocationAddress">Address</label>
            <input type="text" class="form-control" id="editLocationAddress" name="new_address">
          </div>
          <div class="form-group">
            <label for="editLocationCity">City</label>
            <input type="text" class="form-control" id="editLocationCity" name="new_city">
          </div>
          <div class="form-group">
            <label for="editLocationCountry">Country</label>
            <input type="text" class="form-control" id="editLocationCountry" name="new_country">
          </div>
          <!-- New Incident Fields -->
          <h6>Update Incident Details (Optional)</h6>
          <div class="form-group">
            <label for="editIncidentDateTime">Date & Time</label>
            <input type="text" class="form-control" id="editIncidentDateTime" name="new_date_time" placeholder="YYYY-MM-DD HH:MM">
          </div>
          <div class="form-group">
            <label for="editSeverityLevel">Severity Level</label>
            <select class="form-control" id="editSeverityLevel" name="new_severity_level">
              <option value="">-- Select Severity --</option>
              {% for level in severity_levels %}
                <option value="{{ level }}">{{ level }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="editIncidentDescription">Description</label>
            <input type="text" class="form-control" id="editIncidentDescription" name="new_description">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save Changes</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Incident Modal -->
<div class="modal fade" id="deleteIncidentModal" tabindex="-1" role="dialog" aria-labelledby="deleteIncidentModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form method="post" action="{% url 'delete_incident' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="deleteIncidentModalLabel">Delete Incident</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
             <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="deleteIncidentSelect">Select Incident to Delete</label>
            <select class="form-control" id="deleteIncidentSelect" name="incident_id" required>
              <option value="">-- Select Incident --</option>
              {% for incident in fireIncidents %}
                <option value="{{ incident.id }}">{{ incident.description }}</option>
              {% endfor %}
            </select>
          </div>
          <p class="text-danger">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Delete Incident</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
  // Initialize the map
  var map = L.map("map").setView([9.81644, 118.722391], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  // Define the incident icon
  var incidentIcon = L.icon({
    iconUrl: "{% static 'img/fireincident.png' %}",
    iconSize: [50, 50],
    iconAnchor: [25, 50],
    popupAnchor: [0, -50]
  });

  // Array of incidents with lat, lng, popup text, and city designation.
  var incidentData = [
    { lat: 9.7638, lng: 118.7473, popup: "San Pedro", city: "PPCA" },
    { lat: 9.7461, lng: 118.7577, popup: "San Miguel", city: "PPCA" },
    { lat: 9.7706, lng: 118.7635, popup: "San Manuel", city: "PPCB" },
    { lat: 9.7722, lng: 118.7460, popup: "Tiniguiban", city: "PPCB" },
    { lat: 9.8010, lng: 118.6973, popup: "Irawan", city: "PPCC" },
    { lat: 9.6715, lng: 118.7256, popup: "Luzviminda", city: "PPCC" },
    { lat: 9.7389, lng: 118.7336, popup: "Magkakaibigan", city: "PPCA" }
  ];

  // Layer group to hold markers
  var markersLayer = L.layerGroup().addTo(map);

  // Function to render markers based on the selected city filter
  function renderMarkers(filterCity) {
    markersLayer.clearLayers();
    incidentData.forEach(function(incident) {
      if (filterCity === "all" || incident.city === filterCity) {
        L.marker([incident.lat, incident.lng], { icon: incidentIcon })
          .addTo(markersLayer)
          .bindPopup(incident.popup);
      }
    });
  }

  // Initial render for all incidents
  renderMarkers("all");

  // Event listener for filter changes
  document.getElementById("cityFilter").addEventListener("change", function() {
    renderMarkers(this.value);
  });
</script>
{% endblock %}